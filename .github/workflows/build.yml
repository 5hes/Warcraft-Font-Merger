name: build

on:
  push:
  workflow_dispatch:
    inputs:
      build:
        description: "Build otfccpp branch"
        required: true
        type: boolean

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4.2.2

    - uses: xmake-io/github-action-setup-xmake@v1
      with:
        xmake-version: latest
    
    # - run: sudo apt update && sudo apt install make -y

    - name: Replace software sources with the latest
      run: |
        # 删除原有的软件源
        sudo rm -f /etc/apt/sources.list

        # 添加最新的 Ubuntu 24.04 (Noble Numbat) 官方软件源
        echo "deb http://archive.ubuntu.com/ubuntu/ jammy main restricted universe multiverse" | sudo tee /etc/apt/sources.list
        echo "deb http://archive.ubuntu.com/ubuntu/ jammy-updates main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list
        echo "deb http://archive.ubuntu.com/ubuntu/ jammy-security main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list
        echo "deb http://archive.ubuntu.com/ubuntu/ jammy-backports main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list

        wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | sudo apt-key add -
        echo "deb http://apt.llvm.org/focal/ llvm-toolchain-focal-19 main" | sudo tee /etc/apt/sources.list.d/llvm-toolchain.list

    - name: Add Ubuntu GPG key
      run: |
        # 添加 Ubuntu 官方 GPG 密钥
        curl -fsSL http://archive.ubuntu.com/ubuntu/project/ubuntu-archive-keyring.gpg | sudo gpg --dearmour -o /etc/apt/trusted.gpg.d/ubuntu.gpg
        sudo apt update
        sudo apt upgrade -y
        sudo apt install podman
    
    - name: Building
      run: |
        podman run -it --rm -v $PWD:/mnt -v /mnt -e XMAKE_ROOT=y alpine
        apk add bash xmake gcc g++ xz
        package/linux-amd64.sh

    - name: Upload a Build Artifact
      uses: actions/upload-artifact@v4.5.0
      with:
        name: build
        path: build/**

    




  
        
